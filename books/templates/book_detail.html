{% extends "base.html" %}
{% block body_block %}
{% load static %}

    <div class="page-header">
        <h1>{{book.title}}</h1>
        <p class="lead" style="margin-bottom: var(--space-lg);">by {{ book.authors }}</p>
        {% if user.is_authenticated %}
            <div style="margin-top: var(--space-lg); display: flex; gap: var(--space-md); justify-content: center; flex-wrap: wrap;">
                <!-- Library Button -->
                {% if is_owner %}
                    <form method="post" action="{% url 'remove_book' %}">
                        {% csrf_token %}
                        <input type="hidden" name="book_id" value="{{ book.pk }}">
                        <input type="hidden" name="redirect_url" value="single_book">
                        <button type="submit" class="btn" style="background-color: var(--bs-danger); color: white; border: none; min-width: 180px;" onclick="return confirm('Remove this book from your library?')">Remove from Library</button>
                    </form>
                {% else %}
                    <form method="post" action="{% url 'add_to_library' %}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="add_to_library">
                        <input type="hidden" name="id_google" value="{{ book.google_book_id }}">
                        <input type="hidden" name="title" value="{{ book.title }}">
                        <input type="hidden" name="authors" value="{{ book.authors }}">
                        <input type="hidden" name="thumbnail" value="{{ book.thumbnail }}">
                        <input type="hidden" name="description" value="{{ book.description }}">
                        <input type="hidden" name="pageCount" value="{{ book.pageCount }}">
                        <input type="hidden" name="ID_ISBN_13" value="{{ book.ID_ISBN_13 }}">
                        <input type="hidden" name="ID_ISBN_10" value="{{ book.ID_ISBN_10 }}">
                        <input type="hidden" name="ID_OTHER" value="{{ book.ID_OTHER }}">
                        <button type="submit" class="btn btn-primary" style="min-width: 180px;">Add to Library</button>
                    </form>
                {% endif %}

                <!-- Wishlist Button -->
                {% if is_wished %}
                    <form method="post" action="{% url 'remove_from_wishlist' %}">
                        {% csrf_token %}
                        <input type="hidden" name="book_id" value="{{ book.pk }}">
                        <button type="submit" class="btn" style="background-color: var(--bs-secondary); color: white; border: none; min-width: 180px;">Remove from Wishlist</button>
                    </form>
                {% else %}
                    <form method="post" action="{% url 'add_to_library' %}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="add_to_wishlist">
                        <input type="hidden" name="id_google" value="{{ book.google_book_id }}">
                        <input type="hidden" name="title" value="{{ book.title }}">
                        <input type="hidden" name="authors" value="{{ book.authors }}">
                        <input type="hidden" name="thumbnail" value="{{ book.thumbnail }}">
                        <input type="hidden" name="description" value="{{ book.description }}">
                        <input type="hidden" name="pageCount" value="{{ book.pageCount }}">
                        <button type="submit" class="btn" style="background-color: var(--bs-secondary); color: white; border: none; min-width: 180px;">Add to Wishlist</button>
                    </form>
                {% endif %}
            </div>
        {% endif %}
    </div>
        <br>
        <div class="row">
            <div class="col">
                <ul>
                    {% if book.thumbnail %}
                        <img src="{{ MEDIA_URL }}{{ book.thumbnail }}" alt="{{ book.title }}">
                    {% else %}
                        <!-- Placeholder image or alternative content if thumbnail is not available -->
                        <img src="{% static 'generic_thumbnail.jpeg' %}" alt='No Thumbnail found'>
                    {% endif %}
                    <li>Authors: {{book.authors}}</li>
                    <li>Page Count: {{book.pagecount}}</li>
                    <br>
                    <li>Description: {{book.description}}</li>
                </ul>
            </div>
            <div class="col">
                <p>{{book.owner.count}} owner{{book.owner.count|pluralize}}:</p>
                <ol>
                    {% for owner in owners %}
                        <li>
                            <a href="{% url 'user_account' pk=owner.user.pk %}">{{ owner.user.username }}</a>
                            <!-- Only possible to request book if the logged in user does not already own it -->
                            {% if user.is_authenticated and not is_owner %}
                                <form method="post" action="{% url 'request_raised' %}">
                                    {% csrf_token %}
                                    <input type="hidden" name="owner" value="{{ owner.user.pk }}">
                                    <input type="hidden" name="requester" value="{{ user.pk }}">
                                    <input type="hidden" name="google_book_id" value="{{ book.google_book_id }}">
                                    <!-- If already requested then disable button -->
                                    {% if owner.user.username in requested_owner_usernames%}
                                        <button type="submit" class="btn btn-sm" style="background-color: var(--bg-tertiary); color: var(--text-muted); border: 1px solid var(--bg-elevated); cursor: not-allowed;" disabled>Requested</button>
                                    {% else %}
                                        <button type="submit" class="btn btn-sm" style="background-color: var(--bs-secondary); color: white; border: none;">Request</button>
                                    {% endif %}
                                </form>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ol>
            </div>
            <div class="col">
                <p>{{user_wish_count}} wisher{{user_wish_count|pluralize}}:</p>
                <ol>
                    {% for wisher in user_wish %}
                        <li><a href="{% url 'user_account' pk=wisher.user.pk %}">{{ wisher.user.username }}</a></li>
                    {% endfor %}
                </ol>
            </div>
        </div>
    </div>

{% endblock %}
